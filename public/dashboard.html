<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortiFi Security Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Main Dashboard -->
    <div id="main-dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <i class="fas fa-home sidebar-icon active" title="Dashboard" data-page="dashboard"></i>
            <i class="fas fa-search sidebar-icon" title="Scanner" data-page="scanner"></i>
            <i class="fas fa-laptop sidebar-icon" title="Devices" data-page="devices"></i>
            <i class="fas fa-bell sidebar-icon" title="Alerts" data-page="alerts"></i>
            <i class="fas fa-cog sidebar-icon" title="Settings" data-page="settings"></i>
        </div>

        <!-- Dashboard Page -->
        <div class="main-content" id="dashboard-page">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h1>
            
            <div class="summary-cards">
                <div class="card">
                    <h3><i class="fas fa-laptop"></i> Devices</h3>
                    <p>Total: <span id="total-devices">5</span></p>
                    <p>Active: <span id="active-devices">4</span></p>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-bell"></i> Alerts</h3>
                    <p>Active: <span id="active-alerts">2</span></p>
                    <p>Last 24h: <span id="daily-alerts">5</span></p>
                </div>
            </div>
        </div>

        <!-- Devices Page -->
        <div class="main-content hidden" id="devices-page">
            <h1><i class="fas fa-laptop"></i> Managed Devices</h1>
            <div class="device-controls">
                <button class="btn-silence" id="refresh-devices" onclick="location.reload(true)">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="device-grid" id="device-container">
                <!-- Devices will be populated here -->
            </div>
        </div>

        <!-- Nmap Scanner Page -->
        <div class="main-content hidden" id="scanner-page">
            <h1><i class="fas fa-search"></i> Network Scanner</h1>

            <div style="margin-top: 15px;">
                <button id="run-nmap-script" class="btn-scan">
                    <i class="fas fa-terminal"></i> Run Scanner Script
                </button>
            </div>
            <div class="scan-results">
                <h3>Scan Results</h3>
                <div class="results-container">
                    <pre id="scan-results">No scan results yet. Run a scan to see results here.</pre>
                </div>
            </div>
            <script>
                document.getElementById("run-nmap-script").addEventListener("click", async () => {
                    const resultsEl = document.getElementById("scan-results");
                    resultsEl.textContent = "Running scan...";
                    
                    try {
                        const response = await fetch('/run-nmap-script');
                        const data = await response.text();
                        resultsEl.textContent = data;
                    } catch (err) {
                        resultsEl.textContent = "Error running script: " + err.message;
                    }
                });
            </script>
                            

            <!--
            <div class="scanner-controls">
                <div class="scanner-input">
                    <input type="text" id="scan-target" placeholder="Enter IP or hostname (e.g., 192.168.1.1/24)">
                    <button id="start-scan" class="btn-scan">
                        <i class="fas fa-play"></i> Start Scan
                    </button>
                </div>
                <div class="scan-options">
                    <label><input type="checkbox" id="quick-scan" checked> Quick Scan</label>
                    <label><input type="checkbox" id="service-detection"> Service Detection</label>
                    <label><input type="checkbox" id="os-detection"> OS Detection</label>
                </div>
                <script>
                    // When the page loads after a refresh
                    window.onload = function() {
                        if (localStorage.getItem("currentPage") === "scanner-page") {
                            document.getElementById("scanner-page").classList.remove("hidden");
                        }
                    }
                </script>
            </div>
            
            <div class="scan-history">
                <h3>Scan History</h3>
                <div class="history-container">
                    <pre id="scan-history">Loading scan history...</pre>
                </div>
            </div>
        -->
        </div>

        <!-- Devices Page -->
        <div class="main-content hidden" id="devices-page">
            <h1><i class="fas fa-laptop"></i> Managed Devices</h1>
            <div class="device-controls">
                <button class="btn-silence" id="refresh-devices">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="device-grid" id="device-container">
                <!-- Devices will be populated here -->
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="main-content hidden" id="alerts-page">
            <h1>Security Alerts</h1>
            <div class="alert-controls">
                <div class="alert-filters">
                    <select id="alert-severity">
                        <option value="all">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <select id="alert-protocol">
                        <option value="all">All Protocols</option>
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="ssh">SSH</option>
                        <option value="ftp">FTP</option>
                        <option value="tcp">TCP</option>
                        <option value="icmp">ICMP</option>
                        <option value="deauth">Deauth</option>
                        <option value="arp">ARP</option>
                        <option value="mqtt">MQTT</option>
                        <option value="dns">DNS</option>
                    </select>
                    <select id="alert-timeframe">
                        <option value="all">All Time</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                </div>

                <button class="btn-refresh" id="refresh-alerts" onclick="refreshPage()">

                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <script>
                    function refreshPage() {
                        // Save a flag before refresh
                        localStorage.setItem("showAlertsPage", "true");
                        location.reload();
                    }
                    // When the page loads
                    window.onload = function() {
                        if (localStorage.getItem("showAlertsPage") === "true") {
                            // Find the alerts page div
                            var alertsPage = document.getElementById("alerts-page");
                            // Remove the hidden class
                            alertsPage.classList.remove("hidden");
                            // Clear the flag
                            localStorage.removeItem("showAlertsPage");
                        }
                    }
                </script>
            </div>
            
            <table class="alert-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Severity</th>
                        <th>Source IP</th>
                        <th>Protocol</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="alert-list">
                    <!-- Alerts will load here -->
                </tbody>
            </table>
        </div>

        <!-- Settings Page -->
        <div class="main-content hidden" id="settings-page">
            <h1><i class="fas fa-cog"></i> System Settings</h1>
            <div class="settings-section">
                <h3><i class="fas fa-user"></i> User Preferences</h3>
                <div class="setting-item">
                    <label>Theme:</label>
                    <select id="theme-selector">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Notifications:</label>
                    <input type="checkbox" id="notifications-toggle" checked>
                </div>
                <button id="save-settings" class="btn-save"><i class="fas fa-save"></i> Save Settings</button>
                <button id="logout-btn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
                
                <button onclick="openResetPopup()">Reset Password</button>

                <div id="reset-popup" class="modal hidden">
                    <form id="reset-form">
                        <h3>Reset Password</h3>
                        <input type="text" name="username" placeholder="Username" required>
                        <input type="password" name="oldPassword" placeholder="Old Password" required>
                        <input type="password" name="password" placeholder="New Password" required>
                        <div class="modal-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="closeResetPopup()">Cancel</button>
                        </div>
                        <p id="reset-status"></p>
                    </form>                    
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Severity badges */
        .severity-critical {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .severity-high {
            background-color: #e67e22;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .severity-medium {
            background-color: #f1c40f;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        /* Alert table styling */
        .alert-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .alert-table th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .alert-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .alert-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Scanner Page Styles */
        .scanner-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .scanner-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #scan-target {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-scan {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-scan:hover {
            background-color: #218838;
        }

        .scan-options {
            display: flex;
            gap: 15px;
        }

        .scan-results, .scan-history {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .results-container, .history-container {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .modal form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal form input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }

        .modal-buttons button {
            flex: 1;
            margin: 0 4px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-buttons button[type="submit"] {
            background-color: #28a745;
            color: white;
        }

        .modal-buttons button[type="button"] {
            background-color: #dc3545;
            color: white;
        }
    </style>

    <script>
        // DOM Elements
        const elements = {
            mainDashboard: document.getElementById('main-dashboard'),
            sidebarIcons: document.querySelectorAll('.sidebar-icon'),
            logoutBtn: document.getElementById('logout-btn'),
            refreshDevicesBtn: document.getElementById('refresh-devices'),
            saveSettingsBtn: document.getElementById('save-settings')
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar navigation
            elements.sidebarIcons.forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const page = e.target.dataset.page;
                    
                    // Update active icon
                    elements.sidebarIcons.forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Show selected page
                    document.querySelectorAll('.main-content').forEach(el => {
                        el.classList.add('hidden');
                    });
                    document.getElementById(`${page}-page`).classList.remove('hidden');
                });
            });

            // Logout button (if you still want to keep this functionality)
            elements.logoutBtn.addEventListener('click', () => {
                window.location.href = '/logout';
            });

            // Save settings button
            elements.saveSettingsBtn.addEventListener('click', () => {
                alert('Settings saved successfully');
            });
        });

        // Simple filter function for alerts
        function filterTestAlerts() {
            const severity = document.getElementById('alert-severity').value;
            const rows = document.querySelectorAll('#alert-list tr');
            
            rows.forEach(row => {
                const rowSeverity = row.querySelector('span[class^="severity-"]').className;
                const showRow = severity === 'all' || rowSeverity.includes(severity);
                row.style.display = showRow ? '' : 'none';
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('reset-password-modal');
            const openBtn = document.getElementById('reset-password-btn');
            const closeBtn = document.getElementById('close-reset-modal');
            const form = document.getElementById('reset-password-form');

            openBtn.addEventListener('click', () => {
                modal.classList.remove('hidden');
            });

            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                const res = await fetch('/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                alert(result.message || 'Password reset status unknown.');

                if (res.ok) {
                    modal.classList.add('hidden');
                    form.reset();
                }
            });
        });
        function openResetPopup() {
        document.getElementById("reset-popup").classList.remove("hidden");
        }

        function closeResetPopup() {
            document.getElementById("reset-popup").classList.add("hidden");
            document.getElementById("reset-status").textContent = "";
        }

        document.getElementById("reset-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            const form = e.target;
            const statusEl = document.getElementById("reset-status");

            const formData = new FormData(form);
            const data = {
                username: formData.get("username"),
                oldPassword: formData.get("oldPassword"),
                password: formData.get("password"),
            };

            statusEl.textContent = "Processing...";

            const res = await fetch("/reset-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            });

            const text = await res.text();
            if (text.trim() === "success") {
                statusEl.textContent = "Password reset successful. Redirecting...";
                setTimeout(() => {
                    window.location.href = "/logout";
                }, 1000);
            } else {
                statusEl.textContent = text;
            }
        });


        // Add event listeners to filters
        document.getElementById('alert-severity').addEventListener('change', filterTestAlerts);
        document.getElementById('alert-timeframe').addEventListener('change', filterTestAlerts);
        
        // Update dashboard counters
        document.getElementById('active-alerts').textContent = '5';
        document.getElementById('daily-alerts').textContent = '3';
    </script>

    <!-- Scripts -->
    <script src="/js/router.js"></script>
    <script src="/js/devices.js"></script>
    <script src="/js/alerts.js"></script>  
    <script src="/js/scanner.js" type="module"></script>
</body>
</html>